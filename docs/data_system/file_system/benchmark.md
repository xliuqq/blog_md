# 文件系统的性能测试

## fio（TODO）

源码地址：https://github.com/axboe/fio

### 使用



## NNBench

Hadoop 中有一个专门压测**文件系统元数据**性能的组件叫 NNBench。

局限性：

- 单个测试任务是单线程的，资源利用率低；
-  使用 hostname 作为路径名的一部分，没有考虑同一个主机里多个并发任务的冲突问题，会导致多个测试任务重复创建和删除文件，不太符合大数据工作负载的实际情况；

### 使用

```shell
bin/hadoop jar share/hadoop/mapreduce2/hadoop-mapreduce-client-jobclient-2.3.0-cdh5.0.0-tests.jar nnbench -operation create_write -maps 4 -reduces 2 -bytesToWrite 1 -numberOfFiles 2 -replicationFactorPerFile 3 -readFileAfterOpen true -baseDir /benchmarks/NNBench
```





## dfs-perf

源码地址：



## K8s storage



### [longhorn/kbench](https://github.com/longhorn/kbench)

基准测试

- SIZE环境变量：大小应至少为**读/写带宽的 25 倍**，以避免缓存影响结果
- **始终首先针对本地存储进行测试**，以了解基线是什么
- CPU_IDLE_PROF环境变量：CPU 空闲度分析测量 CPU 空闲，但它会带来额外的开销并降低存储性能。默认情况下，该标志处于禁用状态。

#### 指标说明

- **IOPS**：每秒 IO 操作数。*越高越好*

  - 衡量设备在一秒钟内可以处理多少 IO 操作的度量，主要涉及较小的 IO 块，例如 4k。

- **带宽**：也称为**吞吐量**。*越高越好。*

  - 设备在一秒钟内可以读取/写入多少数据的度量。它主要是处理较大的IO块，例如128k。

- **延迟**：每个请求在 IO 路径中花费的总时间。越*低越好*

  - 存储系统处理每个请求的效率的度量

- CPU 空闲：运行测试的节点上的 **CPU 空闲**程度。*越高越好。*

- 对于*比较基准*，`Change`列指示将第二个卷与第一个卷进行比较时的百分比差异。

  - 对于 **IOPS、带宽、CPU 空闲，**正百分比更好。

    对于**延迟**，负百分比更好。
    对于 **CPU 空闲，**显示的不是变化的百分比，而是差异

#### 注意事项

*在以下*情况下出现问题：需要先测试本地存储作为基准。

- **读取*延迟低于本地存储***：IOPS/带宽可能会更高，但是延迟无法比本地存储更低；
  - 如果发生这种情况，很可能是由于存在缓存，增加`SIZE`以避免这种情况。

- ***写入 IOPS/带宽/延迟比本地存储更好***
  - 几乎不可能获得比本机存储更好的写入性能，除非在本地存储前面有一个持久性缓存设备；
  - 如果得到更好的结果，**存储解决方案可能不是崩溃一致**的，因此它不会在响应之前将数据提交到磁盘中，这意味着在发生事故时，可能会丢失数据。

- 对于**延迟基准，CPU的空闲率小于 40%**；
  - 对于**延迟**，CPU **空闲应**至少为 40%，以确保测试不会受到 CPU 不足的影响。