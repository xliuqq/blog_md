# 技巧

## 清理

### 临时文件的清除（上传后不用）

一般来说：先上传文件，然后在将返回的 ID 作为字段存储到数据库中；

问题：上传完文件后，如何知道该文件是否被系统使用，防止垃圾无限增长？



### 被覆盖文件的删除（上传后被覆盖）

**对于用户的头像，多次上传之后，之前的图片应该被删掉。**



### 正常删除

要求：用户一致性，即用户不能看到部分删除的场景。

如：**删除用户时，用户相关的图片数据应该被删掉。**

- 这是两步操作，分别是数据库操作和图片操作。

|                      | 问题                         | 后果                         | 解决方案                     |
| -------------------- | ---------------------------- | ---------------------------- | ---------------------------- |
| 先删数据库，再删图片 | 数据库删除成功，图片删除失败 | 用户可以登录，但无法看到图片 | 加入事务，数据库回滚         |
| 先删数据库，再删图片 | 图片删除成功，数据库删除失败 | 图片无法清除，存留垃圾       | 图片删除事件，单独GC线程处理 |
